<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ Festive Advent Calendar üåü</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Charmonman:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Muted, Aesthetic Christmas Colors */
        :root {
            --color-red: #992d37; /* Deep Cranberry / Burgundy */
            --color-green: #0e5e40; /* Deep Forest Green */
            --color-gold: #c9b07a; /* Antique Brass / Muted Gold */
            --color-dark: #1e252e; /* Deep Charcoal / Near Black */
            --color-dark-accent: #282c35; /* Softened Dark Accent */
            --color-snow: #f4f2ee; /* Creamy Off-white */
            --color-error: #ff6b6b; /* Slightly brighter red for error contrast */
        }

        body {
            font-family: 'Mountains of Christmas', cursive; /* Festive header font */
            /* Muted background gradient */
            background: linear-gradient(135deg, var(--color-dark) 0%, #11151a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px; /* Reduced body padding for mobile screens */
            color: var(--color-snow);
            position: relative;
            overflow: hidden; 
        }

        /* Snowflake animation */
        .snowflake {
            color: var(--color-snow); /* Snow color */
            font-size: 1em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            position: absolute;
            top: -10%;
            animation: fall linear infinite;
            pointer-events: none;
            user-select: none;
            z-index: 1;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        .calendar-container {
            max-width: 1200px;
            width: 100%;
            padding: 1.5rem; /* Mobile-optimized padding */
            border-radius: 1.5rem; /* Slightly smaller border radius for mobile */
            background-color: var(--color-dark-accent);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
            border: 4px solid var(--color-gold); /* Thinner border for mobile */
            position: relative;
            z-index: 10;
        }

        h1 {
            font-family: 'Mountains of Christmas', cursive;
            font-size: 2.5rem; /* Mobile-optimized heading size */
            line-height: 1;
            color: var(--color-snow);
            text-shadow: 0 0 8px rgba(201, 176, 122, 0.8);
            margin-bottom: 0.5rem; /* Reduced margin */
        }
        #date-display, #user-id-display {
            font-family: 'Charmonman', cursive;
            color: var(--color-gold);
            font-size: 1rem; /* Base font size */
        }

        /* Styling for the Advent Door (Closed State) */
        .advent-door {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 2rem; /* Mobile door number size applied to front/back number spans */
            cursor: pointer;
            transition: all 0.5s ease;
            transform-style: preserve-3d;
            position: relative;
            border-radius: 0.75rem; /* Mobile border radius */
            user-select: none;
            perspective: 1000px;
        }

        /* Front face - Closed Door */
        .door-front {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: var(--color-red);
            border: 4px solid var(--color-gold); /* Mobile border size */
            border-radius: 0.75rem;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--color-snow);
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            transition: all 0.5s ease;
        }
        .door-front::before { /* Decorative ribbon */
            content: '';
            position: absolute;
            width: 30%;
            height: 100%;
            background-color: var(--color-green);
            transform: skewX(-20deg);
            left: 35%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .door-front::after { /* Second ribbon */
            content: '';
            position: absolute;
            width: 100%;
            height: 30%;
            background-color: var(--color-green);
            transform: skewY(-20deg);
            top: 35%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .door-front span { /* Make sure number is on top of ribbons */
            position: relative;
            z-index: 1;
        }

        /* Back face - Opened Content (Now purely decorative and clean) */
        .door-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: var(--color-green);
            border: 4px solid var(--color-gold);
            border-radius: 0.75rem;
            transform: rotateY(180deg);
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--color-snow);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        /* Decorative Back Face Content */
        .door-back .door-inner-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: relative;
        }
        .door-back .door-star {
            position: absolute;
            opacity: 0.3; /* Muted star */
            font-size: 4rem; /* Large star on mobile */
            z-index: 1;
        }
        .door-back .door-number-display {
            position: relative;
            z-index: 2;
            font-size: 2rem; /* Consistent size with front on mobile */
            font-weight: bold;
            color: var(--color-snow);
            font-family: 'Mountains of Christmas', cursive;
        }

        /* Opened State (Flipped) */
        .door-opened {
            transform: rotateY(180deg);
            cursor: default;
        }

        /* Locked State (Future Day) */
        .door-locked .door-front {
            background-color: #5a6268;
            color: #d1d5db;
            cursor: not-allowed;
            filter: grayscale(80%);
            pointer-events: none;
        }
        .door-locked .door-front::before,
        .door-locked .door-front::after {
            background-color: #4a5568;
        }

        /* Hover Effect for Openable Doors */
        .advent-door:not(.door-locked):not(.door-opened):hover .door-front {
            background-color: #b33941;
            box-shadow: 0 0 15px var(--color-gold); /* Reduced shadow size */
            transform: scale(1.02);
        }

        /* Modal styling */
        .modal-content {
            padding: 1.5rem; /* Mobile modal padding */
            border-radius: 1rem;
            max-width: 95%; /* Take up more width on mobile */
            width: 400px;
        }
        #modal-title {
            font-size: 2rem; /* Mobile modal title size */
        }
        #modal-message {
            font-size: 1rem; /* Mobile modal message size */
        }
        .modal-button {
            padding: 0.6rem 1.5rem; /* Mobile button size */
            font-size: 1rem;
            margin-top: 1rem;
        }

        /* Responsive grid layout */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns is good for phones */
            gap: 1rem; /* Reduced gap for small screens */
        }

        /* Tablet and Desktop Styles */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            .calendar-container {
                padding: 2.5rem;
                border-radius: 2rem;
                border: 5px solid var(--color-gold);
            }
            h1 {
                font-size: 3.5rem;
                margin-bottom: 1rem;
            }
            .advent-door {
                font-size: 2.5rem; /* Desktop door number size applied to front/back number spans */
                border-radius: 1rem;
            }
            .door-front {
                border: 6px solid var(--color-gold);
                border-radius: 1rem;
            }
            .door-back {
                border: 6px solid var(--color-gold);
                border-radius: 1rem;
                padding: 1.5rem;
            }
            .door-back .door-star {
                font-size: 6rem; /* Large star on desktop */
            }
            .door-back .door-number-display {
                font-size: 2.5rem; /* Consistent size with front on desktop */
            }
            .calendar-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 2rem; /* Wider gap for desktop */
            }
        }
    </style>
</head>
<body>

    <div class="calendar-container">
        <h1 class="text-center mb-2">
            üéÑ The Christmas Countdown üåü
        </h1>
        <p id="date-display" class="text-xl text-center mb-6"></p>
        <p id="user-id-display" class="text-sm text-center mb-8"></p>

        <div id="calendar-grid" class="calendar-grid">
            <!-- Doors will be injected here --></div>

        <div id="loading-spinner" class="text-center mt-10 text-white">
            <svg class="animate-spin h-8 w-8 mx-auto text-yellow-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gold-300">Connecting to the North Pole...</p>
        </div>
    </div>

    <!-- Custom Modal for Messages --><div id="custom-modal" class="modal" onclick="document.getElementById('custom-modal').style.display = 'none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="mb-4"></h3>
            <p id="modal-message" class="mb-6"></p>
            <!-- The link button is now handled here in the modal, not on the door back -->
            <a href="#" target="_blank" class="modal-button" id="modal-content-button"
                    onclick="/* Handled by JS */">
                Ho Ho Ho!
            </a>
            <!-- A simpler close button is hidden by default -->
            <button class="modal-button hidden" id="modal-close-button"
                    onclick="document.getElementById('custom-modal').style.display = 'none'">
                Ho Ho Ho!
            </button>
        </div>
    </div>

    <!-- Firebase SDK Imports --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase Log Level to Debug for development visibility
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES & CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-advent-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        const TODAY = new Date().getDate();
        const CURRENT_MONTH = new Date().getMonth(); // 11 is December (0-indexed)
        const IS_DECEMBER = CURRENT_MONTH === 11;

        // --- UPDATED CALENDAR DATA: Structured for TEXT or LINK ---
        const CALENDAR_DATA = [
            { type: 'link', title: 'Listen to Carol of the Bells', url: 'https://music.apple.com/us/album/carol-of-the-bells/1443494796?i=1443494807' },
            { type: 'text', content: "Did you know Rudolph's nose was originally blue in the story?" },
            { type: 'text', content: "üéÅ Time to wrap a small gift for a loved one!" },
            { type: 'text', content: "Bake some delicious gingerbread cookies today!" },
            { type: 'text', content: "Quote: 'The best way to spread Christmas cheer is singing loud for all to hear.'" },
            { type: 'link', title: 'Listen to Jingle Bells', url: 'https://music.apple.com/us/album/jingle-bells/1507433241?i=1507433246' },
            { type: 'text', content: "Light a pine-scented candle and enjoy the cozy evening." },
            { type: 'text', content: "Write a short, secret letter to Santa." },
            { type: 'text', content: "Watch a classic holiday movie tonight." },
            { type: 'link', title: 'Listen to The Christmas Song', url: 'https://music.apple.com/us/album/the-christmas-song-merry-christmas-to-you/1440786026?i=1440786043' },
            { type: 'text', content: "Tell a friend why you appreciate them." },
            { type: 'text', content: "‚ùÑÔ∏è Go outside and look for snowflakes or frost." },
            { type: 'text', content: "Draw a picture of a snowman or a reindeer." },
            { type: 'link', title: 'Listen to Sleigh Ride', url: 'https://music.apple.com/us/album/sleigh-ride/1544063853?i=1544063857' },
            { type: 'text', content: "Remember a favorite Christmas memory from childhood." },
            { type: 'text', content: "Make a paper snowflake decoration." },
            { type: 'text', content: "Donate an item to a local charity or food bank." },
            { type: 'link', title: 'Listen to Winter Wonderland', url: 'https://music.apple.com/us/album/winter-wonderland/1443494796?i=1443494808' },
            { type: 'text', content: "Read a holiday story aloud." },
            { type: 'text', content: "Look up the recipe for eggnog and try making it!" },
            { type: 'link', title: 'Listen to Deck the Halls', url: 'https://music.apple.com/us/album/deck-the-halls/1507433241?i=1507433248' },
            { type: 'text', content: "Write down three things you are grateful for this season." },
            { type: 'text', content: "Send a text message with a Christmas emoji to three friends." },
            { type: 'link', title: 'Listen to Silent Night', url: 'https://music.apple.com/us/album/silent-night/1507433241?i=1507433249' },
            { type: 'text', content: "üéÖ Merry Christmas! You made it! Enjoy the magic of today." }
        ];


        // --- UI UTILITY FUNCTIONS ---

        function showModal(title, message, isError = false) {
            const modal = document.getElementById('custom-modal');
            const titleElement = document.getElementById('modal-title');
            const messageElement = document.getElementById('modal-message');
            const contentButton = document.getElementById('modal-content-button');
            const closeButton = document.getElementById('modal-close-button');
            
            let displayMessage = '';

            // Set Title and Color
            titleElement.textContent = title;
            titleElement.style.color = isError ? 'var(--color-error)' : 'var(--color-green)';

            // --- Determine Content Type and Configure Modal ---
            if (typeof message === 'object' && message !== null) {
                if (message.type === 'link') {
                    displayMessage = 'Ready for today\'s Christmas tune? Click the button below to listen!';
                    
                    // Show Link Button, Hide Close Button
                    contentButton.textContent = message.title;
                    contentButton.onclick = () => {
                        document.getElementById('custom-modal').style.display = 'none'; 
                        window.open(message.url, '_blank');
                    };
                    contentButton.href = message.url;
                    
                    contentButton.classList.remove('hidden');
                    closeButton.classList.add('hidden');
                    
                } else { // type: 'text'
                    displayMessage = message.content;
                    
                    // Hide Link Button, Show Close Button
                    contentButton.classList.add('hidden');
                    closeButton.classList.remove('hidden');
                }
            } else { 
                // Simple error message (isError=true)
                displayMessage = message; 

                // Hide Link Button, Show Close Button
                contentButton.classList.add('hidden');
                closeButton.classList.remove('hidden');
            }

            messageElement.textContent = displayMessage;
            modal.style.display = 'flex';
        }

        function updateUserIdDisplay(id) {
            document.getElementById('user-id-display').textContent = `User ID: ${id}`;
        }

        function showLoading(isVisible) {
            document.getElementById('loading-spinner').style.display = isVisible ? 'block' : 'none';
        }

        // --- FIREBASE AND AUTHENTICATION ---

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        updateUserIdDisplay(userId);
                        // Once authenticated, start listening to the data
                        listenToDoorState();
                    } else {
                        // This case should ideally not happen if initial sign-in succeeds
                        userId = crypto.randomUUID();
                        updateUserIdDisplay(userId);
                        listenToDoorState();
                    }
                    showLoading(false);
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showModal("Error", "Could not connect to Firebase. Data persistence is disabled.", true);
                showLoading(false);
            }
        }

        // --- FIRESTORE DATA HANDLING ---

        function getDoorDocRef() {
            // Private user data location
            return doc(db, `/artifacts/${appId}/users/${userId}/advent_calendar/status`);
        }

        function listenToDoorState() {
            // Guard clause: ensure db and userId are available
            if (!db || userId === 'loading') {
                console.warn("Firestore listener skipped: DB not ready or user ID loading.");
                return;
            }

            onSnapshot(getDoorDocRef(), (docSnapshot) => {
                let openedDoors = {};
                if (docSnapshot.exists()) {
                    openedDoors = docSnapshot.data() || {};
                    console.log("Current opened doors loaded:", openedDoors);
                } else {
                    console.log("No existing door state found. Initializing.");
                }
                renderCalendar(openedDoors);
            }, (error) => {
                console.error("Error listening to door state:", error);
                showModal("Data Error", "Failed to load saved calendar progress.", true);
                renderCalendar({}); // Render calendar without saved state
            });
        }

        async function saveDoorState(day) {
            if (!db || userId === 'loading') {
                showModal("Persistence Error", "Cannot save progress. Authentication failed.", true);
                return;
            }

            try {
                // Fetch current state, then update it
                const doorRef = getDoorDocRef();
                await setDoc(doorRef, { [day]: true }, { merge: true });
                console.log(`Door ${day} successfully marked as opened.`);
            } catch (e) {
                console.error("Error updating document: ", e);
                showModal("Save Error", `Failed to save progress for Day ${day}.`, true);
            }
        }

        // --- CALENDAR LOGIC & RENDERING ---

        function handleDoorClick(day, element, openedDoors) {
            // 1. Check if it's December
            if (!IS_DECEMBER) {
                 showModal("It's Not Christmas Yet!", `It's currently ${new Date().toLocaleDateString('en-US', { month: 'long' })}. The calendar starts in December!`, true);
                 return;
            }

            // 2. Check if the door is locked
            if (day > TODAY) {
                showModal("Door is Locked", `You must wait until Day ${day} to open this door!`, true);
                return;
            }

            // 3. Check if already opened
            if (openedDoors[day]) {
                // If already opened, show the modal content again (but don't save or flip again)
                const content = CALENDAR_DATA[day - 1];
                const title = `Day ${day} Already Revealed!`;
                showModal(title, content); 
                return;
            }

            // 4. Open the door and save state
            element.classList.add('door-opened');
            saveDoorState(day);

            const content = CALENDAR_DATA[day - 1];
            const title = `Day ${day} Revealed!`;

            // Wait for the flip animation, then show the message
            setTimeout(() => {
                showModal(title, content); // Pass the content OBJECT
            }, 300);
        }

        function renderCalendar(openedDoors) {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = ''; // Clear existing doors

            // Update header
            document.getElementById('date-display').textContent = `Today is Day ${TODAY} of December!`;

            for (let i = 1; i <= 25; i++) {
                const day = i;
                const isLocked = day > TODAY && IS_DECEMBER; // Only lock if it's December and day is in the future
                const isOpened = openedDoors[day];
                
                const doorWrapper = document.createElement('div');
                doorWrapper.className = `advent-door ${isLocked ? 'door-locked' : ''} ${isOpened ? 'door-opened' : ''}`;
                doorWrapper.setAttribute('data-day', day);

                // Add click listener
                doorWrapper.addEventListener('click', () => handleDoorClick(day, doorWrapper, openedDoors));

                // Front (Closed) Face
                const front = document.createElement('div');
                front.className = 'door-front';
                front.innerHTML = `<span>${day}</span>`;

                // Back (Opened) Face - PURELY DECORATIVE WITH PROMINENT NUMBER
                const back = document.createElement('div');
                back.className = 'door-back';
                back.innerHTML = `
                    <div class="door-inner-content">
                        <span class="door-star">‚≠ê</span>
                        <span class="door-number-display">${day}</span>
                    </div>
                `;


                doorWrapper.appendChild(front);
                doorWrapper.appendChild(back);
                grid.appendChild(doorWrapper);
            }
        }

        // --- SNOWFLAKE EFFECT ---
        function createSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.classList.add('snowflake');
            snowflake.innerHTML = '‚ùÖ'; // Or '‚ùÑ' '‚ùÜ' '‚ú®'

            snowflake.style.left = Math.random() * 100 + 'vw';
            snowflake.style.animationDuration = Math.random() * 3 + 4 + 's'; // 4-7 seconds
            snowflake.style.animationDelay = Math.random() * 5 + 's';
            snowflake.style.opacity = Math.random();
            snowflake.style.fontSize = Math.random() * 1 + 0.8 + 'em'; // 0.8em to 1.8em
            document.body.appendChild(snowflake);

            // Remove snowflake after it falls
            snowflake.addEventListener('animationend', () => {
                snowflake.remove();
            });
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // If it's not December, override TODAY for presentation purposes, but keep logic
            if (!IS_DECEMBER) {
                document.getElementById('date-display').textContent = `Today is ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}. Waiting for December...`;
            } else {
                 document.getElementById('date-display').textContent = `Today is Day ${TODAY} of December!`;
            }

            initializeFirebase();

            // Start snowflake generation
            setInterval(createSnowflake, 300); // Create a new snowflake every 300ms
        }

    </script>
</body>
</html>